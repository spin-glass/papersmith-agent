# Papersmith Agent - Web UI 使用ガイド

完全ローカルで動作する論文解析システムのWeb UIの詳細な使用ガイドです。

## 目次

1. [起動方法](#起動方法)
2. [ホームページ](#ホームページ)
3. [論文検索](#論文検索)
4. [RAG質問応答](#rag質問応答)
5. [論文一覧](#論文一覧)
6. [エラーハンドリング](#エラーハンドリング)
7. [トラブルシューティング](#トラブルシューティング)
8. [ベストプラクティス](#ベストプラクティス)

## 起動方法

### Docker Compose使用（推奨）

最も簡単で推奨される方法です：

```bash
# 全サービスを起動
docker-compose up -d

# ログを確認
docker-compose logs -f
```

起動後、以下のURLにアクセスできます：
- **Streamlit UI**: http://localhost:8501
- **FastAPI**: http://localhost:8000
- **API ドキュメント**: http://localhost:8000/docs

### ローカル実行

開発時やDocker未使用の場合：

```bash
# ターミナル1: FastAPI サーバーを起動
uvicorn src.api.main:app --host 0.0.0.0 --port 8000

# ターミナル2: Streamlit UIを起動
streamlit run ui/app.py
# または
./run_ui.sh
```

### 環境変数

UIの動作をカスタマイズする場合：

```bash
# FastAPI のベースURL（デフォルト: http://localhost:8000）
export PAPERSMITH_API_URL=http://localhost:8000

# Streamlit UIを起動
streamlit run ui/app.py
```

## ホームページ

### 概要

ホームページはシステムの入り口で、全体の概要とナビゲーションを提供します。

### 主な機能

#### 1. システム状態の確認

**サイドバー - システム状態セクション:**
- **API接続**: FastAPIサーバーとの接続状態を表示
  - ✓ API接続: 正常（緑色）
  - ✗ API接続: エラー（赤色）
- **インデックス情報**: インデックス済みドキュメント数を表示
- **インデックス状態**: インデックスが準備完了か構築中かを表示

#### 2. ナビゲーション

**サイドバー - 機能セクション:**
- 📖 論文検索: 論文検索ページへ移動
- 💬 RAG質問応答: RAG質問応答ページへ移動
- 📚 論文一覧: 論文一覧ページへ移動

#### 3. システム概要

**メインエリア:**
- 各機能の説明カード
- 使い方の簡単なガイド
- 技術スタックの紹介

### 使用例

1. ブラウザで http://localhost:8501 にアクセス
2. サイドバーでAPI接続状態を確認
3. 「✓ API接続: 正常」が表示されていることを確認
4. サイドバーから使いたい機能を選択

### トラブルシューティング

**「✗ API接続: エラー」が表示される場合:**
- FastAPIサーバーが起動しているか確認
- `docker-compose logs -f papersmith-api` でログを確認
- `curl http://localhost:8000/health` でAPIが応答するか確認

**「インデックス構築中...」が表示される場合:**
- 初回起動時は数分かかる場合があります
- ログで進捗を確認してください
- インデックスが準備完了するまで待ってください

## 論文検索

### 概要

arXiv APIを使用してキーワードで論文を検索し、PDFをダウンロードしてインデックス化します。

### 主な機能

#### 1. 検索フォーム（サイドバー）

**検索キーワード:**
- 論文のタイトル、要約、著者名などで検索
- 英語での検索が推奨（arXiv APIの仕様）
- 複数のキーワードを組み合わせ可能

**最大取得件数:**
- スライダーで1-50件の範囲で指定
- デフォルト: 10件
- 多すぎると検索に時間がかかる場合があります

**検索ボタン:**
- クリックして検索を実行
- 検索中はスピナーが表示されます

#### 2. 検索結果の表示

**論文カード:**
- **タイトル**: 論文のタイトル（青色）
- **著者**: 著者リスト（最大3名表示、それ以上は「他N名」）
- **メタデータ**: 年、arXiv ID
- **要約**: 「📄 要約を表示」をクリックして展開

**アクションボタン:**
- **📥 ダウンロード**: PDFをダウンロードしてインデックス化
- **🔗 PDF**: arXivのPDFページを新しいタブで開く

#### 3. ダウンロードとインデックス化

**ダウンロードボタンをクリックすると:**
1. PDFをダウンロード
2. テキストを抽出
3. IMRaD構造でセクション分割
4. チャンク化（512トークン）
5. Embeddingを生成
6. Chromaベクターストアに保存

**進捗表示:**
- スピナーで進捗を表示
- 完了時に成功メッセージとチャンク数を表示
- 🎈 バルーンアニメーションで完了を祝福

### 使用例

#### 例1: Transformerに関する論文を検索

```
1. サイドバーで検索キーワードに「transformer attention mechanism」を入力
2. 最大取得件数を10に設定
3. 「🔍 検索」ボタンをクリック
4. 検索結果が表示されるまで待つ（数秒）
5. 興味のある論文の「📥 ダウンロード」ボタンをクリック
6. ダウンロードとインデックス化が完了するまで待つ（数分）
7. 成功メッセージとチャンク数を確認
```

#### 例2: 特定の著者の論文を検索

```
1. 検索キーワードに「Vaswani attention is all you need」を入力
2. 検索を実行
3. 該当する論文が見つかったらダウンロード
```

### 検索のヒント

**効果的な検索方法:**
- 具体的なキーワードを使用（例: "BERT language model"）
- 複数のキーワードを組み合わせる（例: "deep learning computer vision"）
- 英語で検索すると精度が向上
- 論文タイトルの一部を使用（例: "attention is all you need"）

**検索例:**
- `transformer attention`
- `deep learning computer vision`
- `reinforcement learning robotics`
- `BERT language model`
- `GPT generative pre-training`

### トラブルシューティング

**「検索結果が見つかりませんでした」と表示される場合:**
- キーワードを変更してみる
- より一般的なキーワードを使用
- スペルミスがないか確認

**ダウンロードが失敗する場合:**
- インターネット接続を確認
- arXiv APIが利用可能か確認
- ディスク容量を確認
- ログでエラー詳細を確認

**ダウンロードが遅い場合:**
- PDFのサイズが大きい可能性があります
- LLMモデルのロードに時間がかかる場合があります
- 初回実行時はモデルのダウンロードが必要です

## RAG質問応答

### 概要

インデックス化された論文に対して質問を投げかけ、LLMが関連情報を基に回答を生成します。

### 主な機能

#### 1. 質問設定（サイドバー）

**インデックス状態:**
- インデックス化された論文の件数を表示
- 論文がない場合は警告メッセージを表示

**論文フィルタ:**
- マルチセレクトで検索対象の論文を選択
- 未選択の場合は全論文が対象
- 選択した論文数を表示

**検索パラメータ:**
- **取得チャンク数 (top_k)**: 1-20の範囲で指定
- デフォルト: 5
- 多いほど多くの情報を参照しますが、処理時間が増加

#### 2. 質問入力フォーム

**質問テキストエリア:**
- 論文の内容に関する質問を入力
- 日本語でも英語でも質問可能
- 複数行の質問も可能

**アクションボタン:**
- **🚀 質問する**: RAGクエリを実行
- **🗑️ クリア**: 結果をクリアして新しい質問を開始

#### 3. 回答の表示

**回答ボックス:**
- LLMが生成した回答を表示
- 青色の背景で強調表示
- 改行を保持して表示

**メタデータ:**
- **サポートスコア**: 検索結果の質を示すスコア（0-1）
- **試行回数**: 検索の試行回数
- **参照チャンク数**: 使用したチャンクの数

**参照元チャンク:**
- 各チャンクをエクスパンダーで表示
- チャンクのテキスト内容
- スコア（類似度）
- 論文ID、セクション、チャンクID

### 使用例

#### 例1: 論文の主な貢献を質問

```
1. 「💬 RAG質問応答」ページに移動
2. サイドバーでインデックス状態を確認
3. 質問テキストエリアに「この論文の主な貢献は何ですか？」を入力
4. 「🚀 質問する」ボタンをクリック
5. 回答が生成されるまで待つ（数十秒〜数分）
6. 回答を確認
7. 参照元チャンクを展開して詳細を確認
```

#### 例2: 特定の論文に絞って質問

```
1. サイドバーの「論文フィルタ」で特定の論文を選択
2. 質問を入力（例: "どのような手法を使用していますか？"）
3. 質問を実行
4. 選択した論文のみから回答が生成される
```

#### 例3: 複数の論文を横断して質問

```
1. 論文フィルタで何も選択しない（全論文が対象）
2. 質問を入力（例: "Transformerの注意機構について説明してください"）
3. 質問を実行
4. 複数の論文から関連情報が検索される
```

### 質問のヒント

**効果的な質問方法:**
- 具体的な質問をする
- 論文の内容に関連する質問をする
- 日本語でも英語でも質問可能
- オープンエンドな質問も可能

**質問例:**
- この論文の主な貢献は何ですか？
- どのような手法を使用していますか？
- 実験結果はどうでしたか？
- この研究の限界は何ですか？
- 提案手法の利点は何ですか？
- どのようなデータセットを使用していますか？
- 関連研究との違いは何ですか？

### トラブルシューティング

**「インデックス化された論文がありません」と表示される場合:**
- まず「📖 論文検索」ページで論文をダウンロード
- ダウンロードが完了していることを確認

**回答生成に時間がかかる場合:**
- LLM推論は時間がかかります（特にCPUモード）
- GPUを使用すると高速化されます
- top_kを減らすと処理時間が短縮されます

**回答が不正確な場合:**
- 質問をより具体的にする
- top_kを増やして多くの情報を参照
- 論文フィルタで特定の論文に絞る

**「503 Service Unavailable」エラーが表示される場合:**
- インデックスが構築中の可能性があります
- 数分待ってから再試行してください

## 論文一覧

### 概要

インデックス化された論文の一覧を表示し、詳細情報を確認できます。

### 主な機能

#### 1. インデックス統計（サイドバー）

**統計情報:**
- **総ドキュメント数**: インデックス内の総チャンク数
- **インデックス状態**: 準備完了か構築中か

**アクション:**
- **🔄 リフレッシュ**: ページをリロードして最新情報を取得

#### 2. 論文一覧の表示

**並び替え:**
- 新しい順（デフォルト）
- 古い順
- タイトル順

**論文カード:**
- タイトル（緑色）
- 著者リスト
- 年、arXiv ID
- インデックス済みチャンク数（推定）

**詳細情報:**
- 「📄 詳細情報」をクリックして展開
- arXiv ID、タイトル、著者、年、PDF URL
- 要約（利用可能な場合）

**アクション:**
- **🔗 PDF**: arXivのPDFページを開く

### 使用例

#### 例1: インデックス化された論文を確認

```
1. 「📚 論文一覧」ページに移動
2. インデックス化された論文の一覧を確認
3. 並び替えオプションで表示順を変更
4. 各論文の詳細情報を展開して確認
```

#### 例2: 特定の論文を探す

```
1. 並び替えを「タイトル順」に変更
2. 目的の論文を探す
3. 詳細情報を展開して確認
4. 「🔗 PDF」ボタンで元の論文を確認
```

### トラブルシューティング

**「インデックス化された論文がありません」と表示される場合:**
- 「📖 論文検索」ページで論文をダウンロード
- ダウンロードが完了していることを確認

**チャンク数が「不明」と表示される場合:**
- 現在の実装では推定値を表示していません
- サイドバーの「総ドキュメント数」で全体のチャンク数を確認

## エラーハンドリング

### エラーメッセージの種類

#### 1. API接続エラー

**表示:**
- 赤色のエラーメッセージ
- 「API接続エラー: サーバーに接続できません」

**原因:**
- FastAPIサーバーが起動していない
- ネットワーク接続の問題

**対処法:**
- FastAPIサーバーを起動
- `docker-compose up -d` を実行
- ログを確認

#### 2. タイムアウトエラー

**表示:**
- 「タイムアウト: サーバーの応答がありません」

**原因:**
- 処理に時間がかかりすぎている
- サーバーが応答していない

**対処法:**
- 処理が完了するまで待つ
- サーバーを再起動
- ログでエラーを確認

#### 3. 503 Service Unavailable

**表示:**
- 「サービス準備中: インデックスを構築しています」

**原因:**
- インデックスが構築中
- 初回起動時

**対処法:**
- 数分待ってから再試行
- ログで進捗を確認

#### 4. HTTPエラー

**表示:**
- 「HTTPエラー (ステータスコード)」

**原因:**
- APIリクエストが失敗
- サーバー側のエラー

**対処法:**
- ログでエラー詳細を確認
- サーバーを再起動
- 問題が解決しない場合はissueを報告

### ローディング状態

**スピナー表示:**
- 処理中はスピナーが表示されます
- メッセージで進捗状況を確認できます

**例:**
- 🔍 'transformer' を検索中...
- 📥 2301.00001 をダウンロード中...
- 🤔 回答を生成中... (LLM推論には時間がかかる場合があります)
- ⏳ インデックス状態を確認中...

## トラブルシューティング

### 一般的な問題

#### UIが起動しない

**確認事項:**
1. FastAPIサーバーが起動しているか
2. ポート8501が使用可能か
3. 依存関係がインストールされているか

**対処法:**
```bash
# FastAPIサーバーを起動
docker-compose up -d papersmith-api

# UIを起動
docker-compose up -d papersmith-ui

# ログを確認
docker-compose logs -f
```

#### API接続エラー

**確認事項:**
1. FastAPIサーバーが起動しているか
2. `http://localhost:8000/health` にアクセスできるか
3. 環境変数 `PAPERSMITH_API_URL` が正しいか

**対処法:**
```bash
# ヘルスチェック
curl http://localhost:8000/health

# サーバーを再起動
docker-compose restart papersmith-api

# ログを確認
docker-compose logs -f papersmith-api
```

#### 論文のダウンロードが失敗する

**確認事項:**
1. インターネット接続が正常か
2. arXiv APIが利用可能か
3. ディスク容量が十分か

**対処法:**
```bash
# ディスク容量を確認
df -h

# ログでエラー詳細を確認
docker-compose logs -f papersmith-api

# キャッシュをクリア
rm -rf cache/pdfs/*
rm -rf cache/metadata/*
```

#### RAG回答が生成されない

**確認事項:**
1. 論文がインデックス化されているか
2. LLMモデルがロードされているか
3. GPUメモリが十分か

**対処法:**
```bash
# インデックス状態を確認
curl http://localhost:8000/health

# ログでエラーを確認
docker-compose logs -f papersmith-api

# GPUメモリを確認
nvidia-smi

# CPUモードで実行
# .envファイルで CUDA_VISIBLE_DEVICES=-1 に設定
```

### パフォーマンスの問題

#### UIが遅い

**原因:**
- サーバーの処理が遅い
- ネットワークの遅延
- リソース不足

**対処法:**
- GPUを使用する
- top_kを減らす
- より小さいモデルを使用
- メモリを増やす

#### LLM推論が遅い

**原因:**
- CPUモードで実行している
- モデルが大きい
- メモリが不足している

**対処法:**
```bash
# GPUを使用
# .envファイルで CUDA_VISIBLE_DEVICES=0 に設定

# より小さいモデルを使用
# .envファイルで LLM_MODEL_NAME を変更

# メモリを確認
free -h
nvidia-smi
```

## ベストプラクティス

### 効率的な使い方

#### 1. 論文の選択

- 関連性の高い論文のみをダウンロード
- 大量の論文をダウンロードしすぎない
- 定期的に不要な論文を削除

#### 2. 検索の最適化

- 具体的なキーワードを使用
- 英語で検索すると精度が向上
- 最大取得件数を適切に設定

#### 3. RAG質問応答の最適化

- 具体的な質問をする
- 論文フィルタで対象を絞る
- top_kを適切に設定（5-10が推奨）

#### 4. リソース管理

- 不要な論文は削除
- 定期的にキャッシュをクリア
- GPUメモリを監視

### セキュリティとプライバシー

#### ローカル実行

- すべての処理がローカルで実行されます
- 論文データは外部に送信されません
- LLMモデルもローカルで実行されます

#### データの保存場所

- **PDF**: `cache/pdfs/`
- **メタデータ**: `cache/metadata/`
- **ベクターストア**: `data/chroma/`
- **モデル**: `models/`

#### データの削除

```bash
# PDFキャッシュを削除
rm -rf cache/pdfs/*

# メタデータキャッシュを削除
rm -rf cache/metadata/*

# ベクターストアを削除
rm -rf data/chroma/*

# すべてのデータを削除
docker-compose down -v
```

### パフォーマンスチューニング

#### GPU使用

```bash
# .envファイル
CUDA_VISIBLE_DEVICES=0  # 最初のGPUを使用
```

#### モデル選択

```bash
# .envファイル
# より小さいモデルを使用（高速だが精度は低下）
LLM_MODEL_NAME=rinna/japanese-gpt-1b

# より大きいモデルを使用（遅いが精度は向上）
LLM_MODEL_NAME=elyza/Llama-3-ELYZA-JP-8B
```

#### チャンクサイズ

- デフォルト: 512トークン
- 小さくすると検索精度が向上するが、チャンク数が増加
- 大きくすると処理が高速化するが、検索精度が低下

## テスト手順

### 基本動作確認

Phase 2実装後、以下の手順で動作確認を行ってください：

#### 1. 環境起動

```bash
docker-compose up -d
curl http://localhost:8000/health  # API確認
```

#### 2. ホームページ確認

- http://localhost:8501 にアクセス
- サイドバーで「✓ API接続: 正常」を確認
- 各機能カードが表示されることを確認

#### 3. 論文検索テスト

- 検索キーワード: "transformer"
- 最大取得件数: 5
- 検索実行 → 結果表示を確認
- 1件ダウンロード → 成功メッセージを確認

#### 4. RAG質問応答テスト

- 質問: "この論文の主な貢献は何ですか？"
- 質問実行 → 回答生成を確認
- 参照元チャンクを確認

#### 5. 論文一覧テスト

- 論文一覧ページに移動
- ダウンロードした論文が表示されることを確認
- 並び替え機能を確認

#### 6. エラーハンドリングテスト

```bash
docker-compose stop papersmith-api  # APIを停止
```

- 各ページでエラーメッセージが適切に表示されることを確認

詳細なテスト項目は `.kiro/steering/testing-guidelines.md` を参照してください。

## まとめ

Papersmith Agent Web UIは、完全ローカルで動作する論文解析システムの直感的なインターフェースです。

**主な利点:**
- 簡単な操作で論文を検索・ダウンロード
- LLMを使用した高度な質問応答
- 完全ローカル実行でプライバシー保護
- リアルタイムのフィードバックとエラーハンドリング

**関連ドキュメント:**
- [README.md](../README.md) - プロジェクト概要
- [DOCKER_GUIDE.md](DOCKER_GUIDE.md) - Docker環境での実行
- [ERROR_HANDLING.md](ERROR_HANDLING.md) - エラー処理の詳細
- [PROJECT_STATUS.md](PROJECT_STATUS.md) - 進捗状況
